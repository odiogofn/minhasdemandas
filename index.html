<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Sistema de Demandas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.48.0/dist/umd/supabase.min.js" defer></script>
  <script src="app.js" defer></script>
</head>
<body>
  <!-- TELA DE LOGIN / CADASTRO -->
  <div id="auth-container" class="auth-card">
    <h1>Sistema de Demandas</h1>
    <div class="auth-columns">
      <div class="auth-box">
        <h2>Entrar</h2>
        <label for="login-email">Email</label>
        <input type="email" id="login-email" />

        <label for="login-senha">Senha</label>
        <input type="password" id="login-senha" />

        <button id="btn-login" class="btn primary" type="button">Entrar</button>
        <p class="hint">Seu acesso só é liberado após aprovação do gestor.</p>
      </div>

      <div class="auth-box">
        <h2>Novo Cadastro</h2>
        <label for="cad-nome">Nome</label>
        <input type="text" id="cad-nome" />

        <label for="cad-email">Email</label>
        <input type="email" id="cad-email" />

        <div class="row">
          <div class="col">
            <label for="cad-dt-nasc">Data de Nascimento</label>
            <input type="date" id="cad-dt-nasc" />
          </div>
          <div class="col">
            <label for="cad-unidade">Unidade</label>
            <select id="cad-unidade">
              <option value="">Selecione...</option>
              <option>ASPEC</option>
              <option>ITARGET</option>
            </select>
          </div>
        </div>

        <label for="cad-tipo">Tipo de Usuário</label>
        <select id="cad-tipo">
          <option value="PROGRAMADOR">Programador</option>
          <option value="ATENDENTE">Atendente</option>
          <option value="GESTOR">Gestor</option>
        </select>

        <div class="row">
          <div class="col">
            <label for="cad-senha">Senha (até 10 caracteres, sem símbolos)</label>
            <input type="password" id="cad-senha" />
          </div>
          <div class="col">
            <label for="cad-senha2">Confirme a senha</label>
            <input type="password" id="cad-senha2" />
          </div>
        </div>

        <button id="btn-cadastrar" class="btn secondary" type="button">Cadastrar Usuário</button>
      </div>
    </div>
    <p id="auth-status" class="status-text"></p>
  </div>

  <!-- APLICACAO PRINCIPAL -->
  <div id="app-container" class="app hidden">
    <header class="topbar">
      <div class="topbar-left">
        <span class="logo">Sistema de Demandas</span>
        <span id="ajuda-perfil" class="perfil-hint"></span>
      </div>
      <div class="topbar-right">
        <span id="user-label" class="user-label"></span>
        <span class="badge ok">Supabase conectado</span>
        <button id="btn-graficos" class="btn ghost" type="button">Gráficos</button>
        <button id="btn-logout" class="btn danger" type="button">Sair</button>
      </div>
    </header>

    <main class="layout">
      <section class="panel" id="sec-cadastro-demanda">
        <div class="panel-header">
          <h2>Cadastro de Demanda</h2>
          <span class="status-bar" id="status-bar">Pronto</span>
        </div>
        <form id="form-demanda" class="form-grid">
          <div class="row">
            <div class="col">
              <label for="dem-municipio">Município</label>
              <input type="text" id="dem-municipio" />
            </div>
            <div class="col">
              <label for="dem-tipo-entidade">Tipo Entidade (CM, PM, CONSORCIO, IPM)</label>
              <input type="text" id="dem-tipo-entidade" />
            </div>
          </div>

          <div class="row">
            <div class="col">
              <label for="dem-contato-cliente">Contato Cliente</label>
              <input type="text" id="dem-contato-cliente" />
              <div id="sugs-contato-cliente" class="chips"></div>
            </div>
            <div class="col">
              <label for="dem-estado">Estado</label>
              <select id="dem-estado">
                <option value="">Selecione...</option>
                <option value="Maranhão">Maranhão</option>
                <option value="Ceará">Ceará</option>
                <option value="Pará">Pará</option>
                <option value="Rio Grande do Norte">Rio Grande do Norte</option>
                <option value="Amapá">Amapá</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div class="col">
              <label for="dem-assunto">Assunto</label>
              <input type="text" id="dem-assunto" />
              <div id="sugs-assunto" class="chips"></div>
            </div>
          </div>

          <div class="row">
            <div class="col">
              <label for="dem-descricao">Descrição</label>
              <textarea id="dem-descricao"></textarea>
            </div>
          </div>

          <div class="row">
            <div class="col">
              <label for="dem-programador">Programador</label>
              <input type="text" id="dem-programador" placeholder="Digite ou clique em sugestões" />
              <div id="sugs-programador" class="chips"></div>
            </div>
            <div class="col">
              <label for="dem-forma-atendimento">Forma de Atendimento (separe por vírgula)</label>
              <input type="text" id="dem-forma-atendimento" placeholder="ANYDESK, EMAIL, TELEFONE..." />
              <div id="sugs-forma-atendimento" class="chips"></div>
            </div>
          </div>

          <div class="row">
            <div class="col">
              <label for="dem-status">Status</label>
              <select id="dem-status">
                <option>ABERTA</option>
                <option>EM ANÁLISE</option>
                <option>NA PROGRAMAÇÃO</option>
                <option>ENCAMINHADA</option>
                <option>CONCLUÍDA</option>
              </select>
            </div>
            <div class="col">
              <label for="dem-prioridade">Prioridade</label>
              <select id="dem-prioridade">
                <option>BAIXA</option>
                <option selected>MÉDIA</option>
                <option>ALTA</option>
                <option>URGENTE</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div class="col">
              <label for="dem-link-trello">Link Trello</label>
              <input type="url" id="dem-link-trello" />
            </div>
            <div class="col">
              <label for="dem-link-email">Link Email (código)</label>
              <input type="text" id="dem-link-email" />
            </div>
          </div>

          <button type="submit" class="btn primary">Salvar Demanda</button>
        </form>
      </section>

      <section class="panel" id="sec-lista-demandas">
        <div class="panel-header">
          <h2>Demandas</h2>
          <div class="filters">
            <input type="text" id="filtro-busca" placeholder="Buscar por descrição, assunto ou código..." />
            <label class="inline">
              <input type="checkbox" id="filtro-ocultar-concluidas" />
              Ocultar concluídas
            </label>
            <select id="filtro-status">
              <option value="TODOS">Todos Status</option>
              <option value="ABERTA">Aberta</option>
              <option value="EM ANÁLISE">Em análise</option>
              <option value="NA PROGRAMAÇÃO">Na programação</option>
              <option value="ENCAMINHADA">Encaminhada</option>
              <option value="CONCLUÍDA">Concluída</option>
            </select>
            <select id="filtro-atendente"></select>
            <select id="filtro-programador"></select>
            <select id="filtro-municipio"></select>
            <select id="filtro-estado"></select>
            <select id="filtro-tipo-entidade"></select>
          </div>
        </div>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>Código</th>
                <th>Município</th>
                <th>Assunto</th>
                <th>Status</th>
                <th>Prioridade</th>
                <th class="col-actions">Ações</th>
              </tr>
            </thead>
            <tbody id="tabela-demandas"></tbody>
          </table>
        </div>
        <p id="total-demandas" class="status-text"></p>
      </section>

      <section class="panel wide" id="sec-painel-gestor">
        <div class="panel-header">
          <h2>Painel do Gestor – Usuários</h2>
        </div>
        <p class="hint">
          Aqui o gestor aprova cadastros, altera tipo/unidade, inativa ou edita nome/email.
        </p>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>Nome</th>
                <th>Email</th>
                <th>Tipo</th>
                <th>Unidade</th>
                <th>Status</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody id="tabela-usuarios"></tbody>
          </table>
        </div>
      </section>
    </main>
  </div>

  <!-- MODAL DE DETALHES -->
  <div id="modal-overlay" class="modal-overlay hidden"></div>
  <div id="modal-detalhes" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="modal-titulo">
    <div class="modal-header">
      <div>
        <h2 id="modal-titulo">Demanda</h2>
        <p class="modal-sub" id="modal-subtitulo"></p>
      </div>
      <button id="btn-fechar-modal" class="btn ghost" type="button">Fechar</button>
    </div>

    <div class="modal-body">
      <input type="hidden" id="det-demanda-id" />

      <div class="modal-section">
        <h3>Resumo</h3>
        <div class="detalhes-grid">
          <div><strong>Código:</strong> <span id="det-codigo"></span></div>
          <div><strong>Município:</strong> <span id="det-municipio"></span></div>
          <div><strong>Tipo Entidade:</strong> <span id="det-tipo-entidade"></span></div>
          <div><strong>Contato Cliente:</strong> <span id="det-contato-cliente"></span></div>
          <div><strong>Estado:</strong> <span id="det-estado"></span></div>
          <div><strong>Assunto:</strong> <span id="det-assunto"></span></div>
          <div class="full"><strong>Descrição:</strong> <span id="det-descricao"></span></div>
          <div><strong>Programador:</strong> <span id="det-programador"></span></div>
          <div><strong>Encaminhar para:</strong> <span id="det-encaminhar-para"></span></div>
          <div><strong>Forma Atendimento:</strong> <span id="det-forma-atendimento"></span></div>
          <div><strong>Prioridade:</strong> <span id="det-prioridade"></span></div>
          <div><strong>Status:</strong> <span id="det-status"></span></div>
          <div><strong>Atendente:</strong> <span id="det-atendente"></span></div>
          <div><strong>Link Trello:</strong> <span id="det-link-trello"></span></div>
          <div><strong>Link Email:</strong> <span id="det-link-email"></span></div>
          <div><strong>Criado em:</strong> <span id="det-criado-em"></span></div>
        </div>
      </div>

      <div class="modal-section" id="sec-acoes-demanda">
        <h3>Ações</h3>
        <div class="acoes-grid">
          <div class="acao-card" id="card-encaminhar">
            <h4>Encaminhar</h4>
            <label for="sel-encaminhar-usuario">Encaminhar para</label>
            <select id="sel-encaminhar-usuario"></select>
            <button id="btn-encaminhar" class="btn primary" type="button">Encaminhar</button>
            <p class="hint">Isso atualiza Programador e Encaminhar Para e muda status para ENCAMINHADA.</p>
          </div>

          <div class="acao-card" id="card-editar">
            <h4>Editar</h4>
            <button id="btn-editar-demanda" class="btn secondary" type="button">Editar campos</button>
            <p class="hint">Somente o criador (Atendente) ou Gestor.</p>
          </div>

          <div class="acao-card danger" id="card-excluir">
            <h4>Excluir</h4>
            <button id="btn-excluir-demanda" class="btn danger" type="button">Excluir demanda</button>
            <p class="hint">Ação permanente.</p>
          </div>
        </div>
      </div>

      <div class="modal-section">
        <h3>Atualizações</h3>
        <ul id="lista-atualizacoes" class="lista-atualizacoes"></ul>

        <form id="form-atualizacao-demanda" class="form-atualizacao">
          <textarea id="nova-atualizacao-texto" placeholder="Registrar novo andamento..."></textarea>
          <button type="submit" class="btn primary">Adicionar atualização</button>
          <p class="hint">A atualização sempre registra o nome do usuário logado.</p>
        </form>
      </div>
    </div>
  </div>
</body>
</html>
